name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  FRONTEND_IMAGE: amandeeprana/inventoryproject_frontend
  BACKEND_IMAGE: amandeeprana/inventoryproject_backend
  KUBE_DEPLOYMENT_NAMESPACE: default

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ” Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # ----------------------------------------------
      # Build + Push Backend Image
      # ----------------------------------------------
      - name: ðŸ—ï¸ Build and Push Backend Image
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "Building backend image with tag: $TAG"
          
          docker build -f ./backend/Dockerfile -t $BACKEND_IMAGE:$TAG ./backend
          docker tag $BACKEND_IMAGE:$TAG $BACKEND_IMAGE:latest
          
          echo "Pushing backend image..."
          docker push $BACKEND_IMAGE:$TAG
          docker push $BACKEND_IMAGE:latest

      # ----------------------------------------------
      # Build + Push Frontend Image
      # ----------------------------------------------
      - name: ðŸ—ï¸ Build and Push Frontend Image
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "Building frontend image with tag: $TAG"
          
          docker build -f ./frontend/Dockerfile -t $FRONTEND_IMAGE:$TAG ./frontend
          docker tag $FRONTEND_IMAGE:$TAG $FRONTEND_IMAGE:latest
          
          echo "Pushing frontend image..."
          docker push $FRONTEND_IMAGE:$TAG
          docker push $FRONTEND_IMAGE:latest

  # ----------------------------------------------
  # Deployment to Minikube
  # ----------------------------------------------
  deploy-to-minikube:
    name: ðŸš€ Deploy to Minikube
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ’¾ Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ðŸ” Configure Kubeconfig for Minikube
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > $HOME/.kube/config

      - name: ðŸ”„ Update Kubernetes Deployments
        run: |
          kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE:latest -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl set image deployment/backend backend=$BACKEND_IMAGE:latest -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl rollout status deployment/frontend -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl rollout status deployment/backend -n $KUBE_DEPLOYMENT_NAMESPACE
