name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
  FRONTEND_IMAGE: amandeeprana/inventoryproject_frontend
  BACKEND_IMAGE: amandeeprana/inventoryproject_backend
  KUBE_DEPLOYMENT_NAMESPACE: default

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v3

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      # Build + Push Backend Image
      - name: üèóÔ∏è Build and Push Backend Image
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "Building backend image with tag: $TAG"
          docker build -t $BACKEND_IMAGE:$TAG .
          docker tag $BACKEND_IMAGE:$TAG $BACKEND_IMAGE:latest
          echo "Pushing backend image..."
          docker push $BACKEND_IMAGE:$TAG
          docker push $BACKEND_IMAGE:latest

      # Build + Push Frontend Image
      - name: üèóÔ∏è Build and Push Frontend Image
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "Building frontend image with tag: $TAG"
          docker build -f ./frontend/Dockerfile -t $FRONTEND_IMAGE:$TAG ./frontend
          docker tag $FRONTEND_IMAGE:$TAG $FRONTEND_IMAGE:latest
          echo "Pushing frontend image..."
          docker push $FRONTEND_IMAGE:$TAG
          docker push $FRONTEND_IMAGE:latest

  deploy-to-k3s:
    name: üöÄ Deploy to K3s Cluster (EC2)
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v3

      - name: üíæ Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: üîê Configure access to K3s cluster
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "‚úÖ K3s kubeconfig set successfully."

      - name: üîÑ Update Kubernetes Deployments on K3s
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "‚öôÔ∏è Updating deployments with new Docker images..."
          kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE:$TAG -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl set image deployment/backend backend=$BACKEND_IMAGE:$TAG -n $KUBE_DEPLOYMENT_NAMESPACE
          echo "‚è≥ Waiting for rollout to complete..."
          kubectl rollout status deployment/frontend -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl rollout status deployment/backend -n $KUBE_DEPLOYMENT_NAMESPACE
          echo "üöÄ Deployment completed successfully on K3s cluster!"
