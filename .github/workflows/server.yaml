name: CI/CD Pipeline (VM K3s)

on:
  push:
    branches:
      - main

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
  FRONTEND_IMAGE: amandeeprana/inventoryproject_frontend
  BACKEND_IMAGE: amandeeprana/inventoryproject_backend
  KUBE_DEPLOYMENT_NAMESPACE: default

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: 🔐 Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: 🏗️ Build and Push Backend Image
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          docker build -t $BACKEND_IMAGE:$TAG .
          docker tag $BACKEND_IMAGE:$TAG $BACKEND_IMAGE:latest
          docker push $BACKEND_IMAGE:$TAG
          docker push $BACKEND_IMAGE:latest

      - name: 🏗️ Build and Push Frontend Image
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          docker build -f ./frontend/Dockerfile -t $FRONTEND_IMAGE:$TAG ./frontend
          docker tag $FRONTEND_IMAGE:$TAG $FRONTEND_IMAGE:latest
          docker push $FRONTEND_IMAGE:$TAG
          docker push $FRONTEND_IMAGE:latest

  deploy-to-k3s:
    name: 🚀 Deploy to K3s VM
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: 💾 Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: 🔐 Configure access to VM K3s cluster
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "✅ VM K3s kubeconfig set successfully."

      - name: 🔄 Update Kubernetes Deployments on VM K3s
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE:$TAG -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl set image deployment/backend backend=$BACKEND_IMAGE:$TAG -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl rollout status deployment/frontend -n $KUBE_DEPLOYMENT_NAMESPACE
          kubectl rollout status deployment/backend -n $KUBE_DEPLOYMENT_NAMESPACE
